# GuestFlow MVP — Анализ ТЗ и рекомендация full-stack стека

Документ фиксирует анализ технического задания и выбранный стек для разработки и масштабирования SaaS-платформы GuestFlow.

---

## 1. Краткий анализ ТЗ (analyzer-style)

**GRADE:** N/A (ТЗ, не код) | **Confidence:** 90% | **Тип:** SaaS Multi-tenant CRM + Telegram White Label  
**Масштаб (из ТЗ):** MVP 50 заведений → v1.0 500+, 100 одновременных бронирований, очереди рассылок, Audit Log, 4 роли.

### Сильные стороны ТЗ

- **Multi-tenant и роли:** Чёткая изоляция по `restaurant_id` и наследование прав — задаёт архитектуру с первого дня.
- **API-first:** Единый API для Web + Bot — основа для масштабирования и будущих клиентов (мобильное приложение и т.д.).
- **Ограничения и безопасность:** Учтены лимиты Telegram (очереди, 30 msg/s) и шифрование токенов ботов.

### Риски по ТЗ

- **HIGH:** Нет явной схемы миграций/версионирования БД и стратегии бэкапов при росте до 500+ тенантов — заложить с первого дня.
- **MED:** Turn Times / Buffer / No-show — распределённые таймеры и консистентность; без выбора (Cron vs workers/очереди) легко получить рассинхрон — 3–5d на проектирование.
- **MED:** «Локализация в UI по часовым поясам» не раскрыта — нужна явная модель (timezone на ресторан, хранение в UTC) — 1d.

**PERF (по требованиям):** Цель — 100 concurrent bookings, очереди рассылок (Redis). Bottleneck по ТЗ — рассылки и Telegram API; без очередей — риск бана.  
**DEBT:** ТЗ готово к старту; следующий шаг — схема БД + API контракты; жизнеспособность 5+ лет при API-first и изоляции по tenant.

---

## 2. Рекомендуемый full-stack стек

### Frontend (Web Admin — панель хостес)

| Компонент | Выбор | Обоснование |
|-----------|--------|-------------|
| **Framework** | **Next.js 15+ (App Router)** | SSR/SSG под SEO и быстрый первый экран; API routes для BFF при желании; одна кодовая база под веб и будущий мобильный PWA. |
| **Язык** | **TypeScript** | Строгая типизация, меньше ошибок при росте модулей (CRM, календарь, рассылки, аналитика). |
| **State** | **TanStack Query (server state) + Zustand (UI state)** | Кэш API, инвалидация, офлайн-устойчивость; лёгкий UI state (модалки, фильтры, табы). Redux не обязателен на старте. |
| **Формы** | **React Hook Form + Zod** | Валидация на клиенте и возможность переиспользования схем на бэке (если позже будет общий пакет типов). |
| **UI** | **Tailwind CSS + Shadcn UI** | Быстрая вёрстка, доступность из коробки, календарь/таблицы/формы без лишнего веса. |
| **i18n** | **next-intl** | Локализация интерфейса и уведомлений по часовым поясам ресторана (как в ТЗ). |

**Итого:** Next.js 15 + TypeScript + TanStack Query + Zustand + React Hook Form + Zod + Tailwind + Shadcn UI + next-intl.

---

### Backend (единый API для Web + Bot)

| Компонент | Выбор | Обоснование |
|-----------|--------|-------------|
| **Framework** | **FastAPI (Python 3.12+)** | Async из коробки (много I/O: БД, Telegram, очереди), автодокументация OpenAPI, валидация Pydantic, типобезопасность. Легко расширять модулями (bookings, guests, notifications, analytics). |
| **Структура** | **Модули по доменам** | `auth`, `tenants`, `guests`, `bookings`, `notifications`, `campaigns`, `analytics`, `audit` — удобно масштабировать команду и код. |

**Альтернативы:** Django + Django Ninja — если важнее админка и ORM «из коробки». Node.js (NestJS) — если команда только JS/TS. Для «Python + рост + API-first» FastAPI даёт лучший баланс.

---

### База данных

| Компонент | Выбор | Обоснование |
|-----------|--------|-------------|
| **Основная БД** | **PostgreSQL 15+** | JSONB для гибких полей (предпочтения гостя, метаданные брони), партиционирование по `restaurant_id` при росте, надёжные транзакции для бронирований и баланса столов. |
| **ORM** | **SQLAlchemy 2.0 (async)** + **Alembic** | Миграции с первого дня, схема под версионирование; при 500+ тенантах — партиции и индексы по `restaurant_id` везде. |
| **Кэш/сессии** | **Redis** | Сессии, rate limiting, блокировки для «один стол — одна бронь в слот», ключи под таймеры no-show/напоминаний (или доп. структуры для очередей). |

**Изоляция:** все запросы фильтровать по `restaurant_id` (middleware/dependency в FastAPI + RLS в PostgreSQL при желании усилить защиту).

---

### Очереди и фоновые задачи

| Компонент | Выбор | Обоснование |
|-----------|--------|-------------|
| **Очереди** | **Redis + Celery** или **Redis + ARQ** | Рассылки в Telegram с лимитом 30 msg/s — одна очередь на платформу, воркеры с rate limit; напоминания за 60 мин, сбор отзывов по таймеру, авто no-show. |
| **Планировщик** | **Celery Beat** или **APScheduler** внутри воркеров | Периодические задачи (напоминания, no-show, отложенные отзывы). |

**Легковесный вариант:** ARQ (async, меньше зависимостей). Для сложных сценариев и мониторинга — Celery + Flower.

---

### Telegram Bot (White Label)

| Компонент | Выбор | Обоснование |
|-----------|--------|-------------|
| **Библиотека** | **python-telegram-bot (v20+)** или **aiogram 3.x** | Async, удобная работа с кнопками и состояниями (FSM для book/profile/feedback). Один воркер на инстанс, маршрутизация по `bot token → restaurant_id` из БД. |
| **Токены** | Хранение в БД (зашифрованное поле), ключ шифрования — в секретах (env/vault). | По ТЗ — AES-256 для токенов ботов. |

Бот только как клиент API: вся бизнес-логика (гости, брони, сегменты, рассылки) — в FastAPI; бот вызывает API и отправляет сообщения в Telegram.

---

### Инфраструктура и DevOps

| Компонент | Выбор | Обоснование |
|-----------|--------|-------------|
| **Контейнеризация** | **Docker + Docker Compose** | Один `docker-compose` для dev: app, worker, PostgreSQL, Redis, (опционально) Nginx. Для прода — те же образы. |
| **Оркестрация (позже)** | **Kubernetes** или **Docker Swarm** | При росте до 500+ заведений — масштабирование воркеров и инстансов API. |
| **Обратный прокси** | **Nginx** или **Traefik** | SSL, маршрутизация, при необходимости — rate limit на уровне LB. |
| **Секреты** | **Environment variables** + опционально **HashiCorp Vault** | Токены ботов, ключи шифрования, строки подключения — не в коде. |
| **Мониторинг** | **Prometheus + Grafana** (или готовый облачный APM) | Метрики API, очередей, ошибок; алерты при падении воркеров или росте задержек. |

---

## 3. Сводная таблица стека

| Слой | Технологии |
|------|------------|
| **Frontend** | Next.js 15, TypeScript, TanStack Query, Zustand, React Hook Form, Zod, Tailwind, Shadcn UI, next-intl |
| **Backend API** | FastAPI (Python 3.12+), Pydantic v2, структура по доменам |
| **БД** | PostgreSQL 15+, SQLAlchemy 2.0 (async), Alembic |
| **Кэш/очереди** | Redis (кэш, сессии, очереди рассылок и задач) |
| **Фоновые задачи** | Celery + Redis (или ARQ) + Beat/APScheduler |
| **Telegram** | python-telegram-bot v20 или aiogram 3, бот как клиент API |
| **Инфраструктура** | Docker, Docker Compose, Nginx/Traefik, env/vault для секретов |
| **Позже** | K8s/Swarm, Prometheus/Grafana, централизованные логи |

---

## 4. Что это даёт для будущего развития

- **Масштаб:** Горизонтальное масштабирование API и воркеров; PostgreSQL с партициями и индексами по `restaurant_id`; одна очередь рассылок с rate limit.
- **Расширение функционала:** Новые модули (платежи, интеграции с POS, мобильное приложение) — как новые домены в API и новые экраны во фронте без переписывания ядра.
- **Безопасность и соответствие ТЗ:** Изоляция по tenant, Audit Log в БД, шифрование токенов, единая точка входа (API).
- **Команда:** Чёткое разделение: фронт (TypeScript), бэкенд (Python), БД/миграции (Alembic), инфраструктура (Docker/Compose).

---

*Документ создан для проекта GuestFlow MVP. Следующий шаг: схема БД и список API endpoints — см. `guestflow-database-and-api.md`.*
